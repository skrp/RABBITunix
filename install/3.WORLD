#!/usr/local/bin/perl
use strict; use warnings;
use File::Copy;
###########################
# WORLD - buildworld 
###########################
my ($usb, $node) = @ARGV;
die "ARG1 /usb ARG2 node\n" unless (defined $node);
$usb =~ s%/\z%%;
###########################
chdir("$usb/KERN/") or die "FAIL $usb\n";;
###########################
`zfs create zroot/usr/ANONI`;
`zfs create zroot/usr/ANONI/home`;
`zfs create zroot/usr/ANONI/WORLD`;
`zfs create zroot/usr/ANONI/CNT`;
`zfs create zroot/usr/ANONI/dump`;
`mkdir /usr/ANONI/dump/pool`;
`mkdir /usr/ANONI/dump/g`;
`chmod 333 /usr/ANONI/dump/pool`;
`chmod 333 /usr/ANONI/dump/g`;
###########################
`zfs create zroot/usr/nfs`;
`zfs set sharenfs=on zroot/usr/nfs`;
###########################
`zfs create -o mountpoint=/usr/ANONI/HIVE zroot/HIVE`;
mkdir("/usr/ANONI/HIVE/BIO/");
mkdir("/usr/ANONI/HIVE/TODO/");
mkdir("/usr/ANONI/HIVE/FEED/");
mkdir("/usr/ANONI/HIVE/FEED/norm");
`touch /usr/ANONI/HIVE/PING`;
###########################
my (@bin) = glob("bin/*");
chomp @bin;
`cp $_ /bin/` for (@bin);
###########################
`cp ../BANK/pf_net /etc/pf_net`;
#`cp conf/fstab /etc/fstab`;
`cp conf/src.conf /etc/src.conf`;
`cp conf/make.conf /etc/make.conf`;
`cp conf/motd /etc/`;
`cp conf/purgehost /etc/`;
`cp conf/pf.conf /etc/pf.conf`;
`cp conf/ntpd.conf /usr/local/etc/ntpd.conf`;
`cp conf/rc.conf /etc/rc.conf`;
#`cp conf/resolv.conf /etc/resolv.conf`;
`cp conf/sshd_config /etc/ssh/sshd_config`;
#`cp conf/start_if.em0 /etc/start_if.em0`;
#`cp conf/start_if.re0 /etc/start_if.re0`;
`cp conf/ttys /etc/ttys`;
`cp conf/KERN /usr/src/sys/amd64/conf/KERN`;
`cp conf/sysctl.conf /etc/sysctl.conf`;
`cp conf/jail.conf /etc/jail.conf`;
`cp conf/login.conf /etc/login.conf`;
`cp conf/exports /etc/exports`;
###########################
my $hn = `hostname`; chomp $hn;
`echo hostname='$hn' >> /etc/rc.conf`;
###########################
print"\nFILES U MUST NOW EDIT: rc.conf  pf.conf resolv.conf jail.conf\n";
###########################
`pw userdel toor`;
###########################
open(my $hfh, '<', '/etc/purgehost');	
my @lines = readline $hfh;
close $hfh; chomp @lines;
chdir("/");
`rm -rf $_` for (@lines);
###########################
my $shell = '/bin/csh';
my $home = "/usr/home/con/";
my $cusb = "/usr/home/con/usb/";
`mkdir $home`;
`mkdir $cusb`;
`cp $usb/KERN/conf/.cshrc $home`;
`echo con | pw useradd -h 0 -n con -d $home -s $shell`;
`chmod -R 700 $home`;
`chown -R con $home`;
############################
# HEIR #####################
# rabbit -> con_host -> ANONI_jail -> heir_jail -> rabbit_host -> root 
############################
my @clan = cr_clan();
my $limit = 1000;
my @list = 1..$limit;
mkdir("/root/clan");
############################
cr_home($_) for (@list);
cr_usr($_) for (@list);
cr_key($_, $node) for (@list);
############################
sub cr_home
{
	my ($usr) = @_;
############################
	my $home = "/usr/home/$usr/";
	`mkdir $home`;
############################
	my $ssh = $home.'.ssh/';
	my $auth = $usb.'/BANK/authorized_keys';
	my $nauth = $ssh.'authorized_keys';

	mkdir("$ssh");
	copy($auth, $ssh); 

	`cp $usb/KERN/conf/.vimrc $home`;

	`chown -R $usr $ssh`;
############################
	`cp $usb/KERN/conf/.cshrc $home`;
}
############################
sub cr_usr
{
	my ($usr) = @_;
	my $home = "/usr/home/$usr/";
	`pw useradd -n $usr -d $home -s $shell`;
	`chmod -R 700 $home`;
	`chown -R $usr $home`;
	
	my $clan = clan();
	`pw usermod $usr -G $clan`;
	`echo '$usr' >> /root/clan/$clan`; 
	print "$usr created\n";
}
############################
sub cr_key
{
	my ($usr, $node) = @_;
############################
	my $idump = $usb."/BANK/host/$node/$usr";
	my $key = "/usr/home/$usr/.ssh/id_rsa";
	my $remote = $key.'.pub';
	`mkdir -p $idump`;
############################
	my $pass;
	my $cnt = 0;
	while ($cnt < 5)
	{
		my $in = int(rand(1000));
		$pass .= " $in";
		$cnt++;
	}
############################
	`ssh-keygen -q -N "$pass" -t rsa -b 2048 -f $key`;
############################
	copy($remote, "$idump/id_rsa.pub");
	`echo "$pass" > $idump/p`;
############################
	print "$key created\n";
}
############################
sub cr_clan
{
	my @c = qw(wheel clan rep world pf zfs usb hive src);
############################
	push(@clan, $_) for (@c);
	push(@clan, "x$_") for (@c);
############################
	`pw groupadd $_` for (@clan);
	return @clan;
############################
}
sub clan
{
	my $rnum = `jot -r 1 0 16`;
	my $clan = $clan[$rnum];
	return $clan;	
}
############################
sub neopass
{
	my @p = qw(0 . 1 2 3 4 5 6 + 7 8 9 / * - q w e r a s d f z x c v);
	my @set = `jot -r 5 0 27`;
	my $pass;
############################
	my $cnt2 = 0;
	while ($cnt2 < 5)
	{
		$pass .= ' ' unless ($cnt2 == 0); 
		my @set = `jot -r 5 0 27`;
		$pass.=$p[$_] for (@set);
		$cnt2++;
	}
############################
	return $pass;
}
